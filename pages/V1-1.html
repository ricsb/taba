<html>
  <head>
    <!--
    MODIFICATIONS
    * WebGL uglyfied
    * Camadas.js reincorporado
    -->
    <title>PeriscopeSimulator - Ricardo</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  </head>
  <body style="background-color: #aaccff;margin: 0px;overflow: hidden;">

    <script src="js/three/three.js"></script>
    <script src="js/Auxiliares.js"></script> 
    <script src="js/Alvos.js"></script>
    <script src="js/Principais.js"></script>
    <script src="js/Eventos.js"></script>
    <script src="js/loaders/MTLLoader.js"></script>
    <script src="js/loaders/OBJMTLLoader.js"></script>
    <script type="text/javascript" src="js/SpriteParticleSystem.js"></script>
    <script src="js/mixer.js"></script>
    <script id="vertShaderEnvMap" type="x-shader/x-vertex">
      attribute vec4 tangent;uniform vec2 uRepeat;uniform vec2 uOffset;varying vec3 vWorldPosition;varying vec3 vViewPosition;varying vec3 vNormal;varying vec2 vUv;varying vec3 vTangent;varying vec3 vBitangent;void main() {vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;vViewPosition = -mvPosition.xyz;vUv = uv * uRepeat + uOffset;vNormal = normalize( normalMatrix * normal );vTangent = normalize( normalMatrix * tangent.xyz );vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );gl_Position = projectionMatrix * mvPosition;}
    </script>

    <script id="fragShaderEnvMap" type="x-shader/x-fragment">
      /**
       * Third part script in this block
       */
      //
      // Description : Array and textureless GLSL 2D/3D/4D simplex
      //               noise functions.
      //      Author : Ian McEwan, Ashima Arts.
      //  Maintainer : ijm
      //     Lastmod : 20110822 (ijm)
      //     License : Copyright (C) 2011 Ashima Arts. All rights reserved.
      //               Distributed under the MIT License. See LICENSE file.
      //               https://github.com/ashima/webgl-noise
      //

      vec3 mod289(vec3 x){return x - floor(x * (1.0 / 289.0)) * 289.0;}vec4 mod289(vec4 x){return x - floor(x * (1.0 / 289.0)) * 289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}float snoise(vec3 v){const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);vec3 i  = floor(v + dot(v, C.yyy) );vec3 x0 =   v - i + dot(i, C.xxx) ;vec3 g = step(x0.yzx, x0.xyz);vec3 l = 1.0 - g;vec3 i1 = min( g.xyz, l.zxy );vec3 i2 = max( g.xyz, l.zxy );vec3 x1 = x0 - i1 + C.xxx;vec3 x2 = x0 - i2 + C.yyy;vec3 x3 = x0 - D.yyy;i = mod289(i);vec4 p = permute(permute(permute(i.z + vec4(0.0, i1.z, i2.z, 1.0 ))+ i.y + vec4(0.0, i1.y, i2.y, 1.0 ))+ i.x + vec4(0.0, i1.x, i2.x, 1.0 ));float n_ = 0.142857142857;vec3  ns = n_ * D.wyz - D.xzx;vec4 j = p - 49.0 * floor(p * ns.z * ns.z);vec4 x_ = floor(j * ns.z);vec4 y_ = floor(j - 7.0 * x_ );vec4 x = x_ *ns.x + ns.yyyy;vec4 y = y_ *ns.x + ns.yyyy;vec4 h = 1.0 - abs(x) - abs(y);vec4 b0 = vec4( x.xy, y.xy );vec4 b1 = vec4( x.zw, y.zw );vec4 s0 = floor(b0)*2.0 + 1.0;vec4 s1 = floor(b1)*2.0 + 1.0;vec4 sh = -step(h, vec4(0.0));vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;vec3 p0 = vec3(a0.xy,h.x);vec3 p1 = vec3(a0.zw,h.y);vec3 p2 = vec3(a1.xy,h.z);vec3 p3 = vec3(a1.zw,h.w);vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));p0 *= norm.x;p1 *= norm.y;p2 *= norm.z;p3 *= norm.w;vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);m = m * m;return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),dot(p2,x2), dot(p3,x3) ) );}uniform samplerCube tCube;uniform sampler2D tNormal;uniform float time;uniform vec2 uOffset;uniform vec3 ambientLightColor;uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];uniform float fogNear;uniform float fogFar;uniform vec3 fogColor;uniform bool useNoisePerturbations;varying vec3 vTangent;varying vec3 vBitangent;varying vec3 vWorldPosition;varying vec3 vViewPosition;varying vec3 vNormal;varying vec2 vUv;void main(){vec3 normColor = texture2D(tNormal, vUv).xyz * 2.0 - 1.0;mat3 tsb = mat3(normalize(vTangent), normalize(vBitangent), normalize(vNormal));vec3 finalNormal = tsb * normColor;if (useNoisePerturbations) {float lowFrequency = snoise(vec3(vUv.x * 10.0, vUv.y * 100.0, time * 0.25));float highFrequency = snoise(vec3(vUv.x * 5000.0, vUv.y * 5000.0, time));lowFrequency = (lowFrequency * 2.0 - 1.0) * 0.2;highFrequency = (highFrequency * 2.0 - 1.0) * 0.05;finalNormal.x += lowFrequency + highFrequency;finalNormal.z += lowFrequency + highFrequency;}finalNormal = normalize(finalNormal);vec3 envReflection = normalize(vWorldPosition - cameraPosition);envReflection = reflect(envReflection, normColor.xzy);envReflection.y = abs(envReflection.y);vec4 reflectionColor = textureCube( tCube, envReflection);vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ 0 ], 0.0 );vec3 dirVector = normalize( lDirection.xyz );float dirDiffuseWeight = (dot( finalNormal, dirVector ) * 0.5) + 0.5;vec3 finalColor = mix(reflectionColor.xyz, vec3(0.235, 0.337, 0.475), 0.975) * dirDiffuseWeight;float depth = gl_FragCoord.z / gl_FragCoord.w;float fogFactor = smoothstep(fogNear, fogFar, depth);finalColor = mix(finalColor, fogColor, fogFactor);gl_FragColor = vec4(finalColor, 1.0);}
    </script>

    <script type="text/javascript">

/**
 *@author ricardoSBastos
 */

//Unbound and Empty
var camera, camera1, camera2, camera3;
var controles, scene, renderer, mainCanvas;
var perOverlay, chartOverlay;
var mesh, texture, geometry, skyMaterial, fragata, corveta;
var TargetObj, TargetParent;
var targetArray = new Array();
var testMaterial;
var uniforms;
var normalTexture;
var colisores = new Array();
var telaEstadimetro;
var canvasContainer;
var parlatorium;
var psys;
var lastMode;
var fazOMovimento;

// Bound
var simTime = 0;
var ivh = 0;
var io1 = 180;
var tgt1Time = 0;
var io2 = 180;
var tgt2Time = 0;
var lastRenderTime = 0;
var now = 0;
var clock = new THREE.Clock();
var tBearing = "000.0";
var rBearing = "325.0";
var distance = "00000.0";
var stad = "";
var sbHead = 35.0;
var periscope = new THREE.Object3D();
var periRotVeloc = 5;
var estadiVeloc = 0.001;
var deltaT = 1;
var beaufort = Math.floor(10 * Math.random()) / 3;
var quat = new THREE.Quaternion();
var elevation = 0;
var fov = 40;
var corrida = 1;
var zoom = "1.5x";
var maxDist = 1000;
var tgtHeight = 0; // altura em p�s
var grauEstadimetro = 0;
var tempoIndiscreto = 0;
var loadedShips = 0;
var subPos = new THREE.Vector3(0, 0, 0);
var points = 50;
var centerMsg = "";

// Booleans
var chartSmall = true;
var turnRight = false;
var turnLeft = false;
var turnUp = false;
var turnDown = false;
var tudoPronto = false;
var modoEstadimetro = false;
var mapa = true;
var fragPos = false;
var corvPos = false;
var paused = false;
var music = true;
var avisando = false;
var varredura = false;
var tgt1 = false;
var primatgt1 = true;
var tgt2 = false;
var primatgt2 = true;
var gameOver = false;

// Constants
var SCREEN_WIDTH = window.innerWidth;
var SCREEN_HEIGHT = window.innerHeight;
var X_UNIT = new THREE.Vector3(1, 0, 0);
var X_UNIT_NEG = new THREE.Vector3(-1, 0, 0);
var Y_UNIT = new THREE.Vector3(0, 1, 0);
var Y_UNIT_NEG = new THREE.Vector3(0, -1, 0);
var Z_UNIT = new THREE.Vector3(0, 0, 1);
var Z_UNIT_NEG = new THREE.Vector3(0, 0, -1);
var aps = {NAVIGATION: 1, PERISCOPE: 2, INFO: 3, LOADING: 5, GAME_OVER: 6};
var mode = aps.LOADING;

// Images
var carta = new Image();
carta.src = "textures/carta.png";
var circle = new Image();
circle.src = "textures/circle1.png";
var subIco = new Image();
subIco.src = "textures/U-209icone.gif";
var hvuIco = new Image();
hvuIco.src = "textures/carrierIcone.gif";
var fragIco = new Image();
fragIco.src = "textures/carrierIcone.gif";
var loadImg = new Image();
loadImg.src = "textures/loadImg.png";
var infoImg = new Image();
infoImg.src = "textures/info.png";
var varHor = new Image();
varHor.src = "textures/vh.png";
var obs1 = new Image();
obs1.src = "textures/obs1.png";
var obs2 = new Image();
obs2.src = "textures/obs2.png";
var next = new Image();
next.src = "textures/next.png";
var previous = new Image();
previous.src = "textures/previous.png";
var tutor1 = new Image();
tutor1.src = "textures/tutor1.png";
var tutor2 = new Image();
tutor2.src = "textures/tutor2.png";
var tutor3 = new Image();
tutor3.src = "textures/tutor3.png";
var tutor = [tutor1, tutor2, tutor3];
var tutorIndex = 0;
var gameOver = new Image();
gameOver.src = "textures/gameOver.png";

// Sounds
Mixer.init(10);
var snd = MediaLoader.loadSound("music", "sounds/Five_Armies.wav");
var chan1 = Mixer.play(snd, 0.0, true);

// Strings
// Coming Soon: A version in two idioms!!
var port = ["Altura do Alvo (em P�s)", "Estad�metro",
  "Exposi��o",
];
var eng = ["Target Height (feet)", "Stadimeter",
  "Exposition"
];
parlatorium = eng;

/* ************************************************** */
/* *****************Camadas.js*********************** */

function overlayParent() {
    this.overlay;
    this.context;
    
    // Helpers
    /** Translates the origin to the top-left corner
      * and draws the same position on 2D canvas
      */
    this.worldToChart2D = function (pos,chartWidth,chartHeight){
    //tirar multiplicadores do maxDist
      var xW = pos.x + maxDist/3;   
      var yW = pos.z + maxDist/3;
      var xC = ((chartWidth - chartHeight)/2)*(xW/(maxDist/3*2));
      var yC = chartHeight*(yW/(maxDist/3*2));
      var pos2D = new THREE.Vector2(xC+(chartWidth - chartHeight)/2,yC);
      return pos2D;
    };
    
    
    
    this.create = function (){
      canvasContainer = document.createElement('div');
      canvasContainer.style.zIndex = '100';
      document.body.appendChild(canvasContainer);
      var overlayCanvas = document.createElement('canvas');
      overlayCanvas.style.position = 'absolute';
      var W =SCREEN_WIDTH;
      var H = SCREEN_HEIGHT;
      switch (this.type){
        case "PERISCOPE":
          overlayCanvas.style.left = '0px';
          overlayCanvas.style.top = '0px';
          overlayCanvas.width = W;
          overlayCanvas.height = H;
        break;
        case "CHART":
          overlayCanvas.style.left = "75%";
          overlayCanvas.style.top = "70%";
          overlayCanvas.width = W/4;
          overlayCanvas.height = H/4;
          overlayCanvas.style.zIndex=100;
      }
      canvasContainer.appendChild(overlayCanvas);
      this.overlay = overlayCanvas;
    };
    
    this.draw = function(){
      if(!this.overlay || avisando)return;
      this.context = this.overlay.getContext('2d');
      var x = window.innerWidth/2;
      var y = window.innerHeight;
      switch(mode){
        case aps.PERISCOPE:
          this.context.clearRect(0, 0, x*2,y);
          var imgCorner = (SCREEN_WIDTH - SCREEN_HEIGHT)/2;
          this.context.drawImage(circle,0,0,SCREEN_WIDTH,SCREEN_HEIGHT);
          this.context.font = "30pt Impact";
          this.context.fillStyle = "#ff0000"; // text color
          this.context.fillText(tBearing,x/2, y-10);
          this.context.fillText(rBearing,x*1.5, y-10);
          this.context.fillText(distance,x-50, 50);
          this.context.fillText(centerMsg,x-50,y/2 - 10);
          this.context.font = "20pt Impact";
          this.context.fillStyle = "#000000";
          this.context.fillText(zoom,x/3,30);
          this.context.fillStyle = "#0000cc";
          this.context.fillText(stad,5*x/4,30);
          this.context.fillStyle = "#ffffff";
          var tempo = parlatorium[2]+"-> "+toClockLike(tempoIndiscreto);
          var v = "HSI -> "+toClockLike(ivh);
          var t1 = "OI-1 -> "+toClockLike(tgt1Time);
          var t2 = "OI-2 -> "+toClockLike(tgt2Time);
          this.context.fillText(tempo,0,30);
          this.context.fillText("Points: "+points,0,70);
          this.context.fillText(v,0,y-110);
          this.context.fillText(t1,0,y-70);
          this.context.fillText(t2,0,y-30);
          this.context.beginPath();
          this.context.moveTo(x,0);
          this.context.lineTo(x,y);
          this.context.moveTo(0,y/2);
          this.context.lineTo(x*2,y/2);
          for (var i=1;i<10;i++){
            this.context.moveTo(x-160,i*y/10);
            this.context.lineTo(x-110,i*y/10);
          }
          this.context.stroke();
          this.context.closePath();
        break;
        case aps.NAVIGATION:
          this.context.drawImage(carta,0,0,x*2,y);
          this.context.drawImage(obs2,x*2-140,y-140,100,100);
          this.context.drawImage(obs1,x*2-280,y-140,100,100);
          this.context.drawImage(varHor,x*2-420,y-140,100,100);
          var tempo = parlatorium[2]+"-> "+toClockLike(tempoIndiscreto);
          var v = "IVH -> "+toClockLike(ivh);
          var t1 = "OI-1 -> "+toClockLike(tgt1Time);
          var t2 = "OI-2 -> "+toClockLike(tgt2Time);
          this.context.font = "20pt Impact";
          this.context.fillStyle = "#ffffff";
          this.context.fillText(tempo,0,30);
          this.context.fillText("Points: "+points,0,70);
          this.context.fillText(v,0,y-110);
          this.context.fillText(t1,0,y-70);
          this.context.fillText(t2,0,y-30);
          var subPosition = this.worldToChart2D(subPos,x*2,y);
          this.context.drawImage(subIco,subPosition.x-16,subPosition.y-12,32,24); 
          //for ( t in targetArray){
            //if (!t.prontoPara)continue;
            if(fragPos){
              var tgt1Pos = this.worldToChart2D(fragPos,x*2,y);   
              this.context.drawImage(hvuIco,tgt1Pos.x-30,tgt1Pos.y-15,60,30);
            }
            if (corvPos){
              var tgt2Pos = this.worldToChart2D(corvPos,x*2,y);   
              this.context.drawImage(fragIco,tgt2Pos.x-30,tgt2Pos.y-15,60,30);
            }
        break;
        case aps.INFO:
          this.clear();
          this.context.drawImage(infoImg,0,0,x*2,y);
        break;
        case aps.LOADING:
          this.clear();
          this.context.drawImage(loadImg,0,0,x*2,y);
        break;
        case aps.TUTOR:
          this.clear();
          this.context.drawImage(tutor[tutorIndex],0,0,x*2,y);
          if(tutorIndex <2)this.context.drawImage(next,x*2-140,y-140,100,100);
          if(tutorIndex >0)this.context.drawImage(previous,40,y-140,100,100);
        break;
        case aps.GAME_OVER:
          this.clear();
          this.context.drawImage(gameOver,0,0,x*2,y);
        break;
      }
      this.context.restore();
      
    };
    
    this.avisa = function(str,t){
      avisando = true;
      var cont = 0;
      var x = window.innerWidth/2 - str.length*10;
      var y = window.innerHeight/2 - 30;
      this.context.font = "40px Impact";
      this.context.fillStyle = "#ff0000"; 
      this.context.fillText(str,x, y);
      setInterval (this.limpAviso,t*1000);
    };
    this.limpAviso = function(){avisando = false;};
     
    this.clear = function(){
      this.context.clearRect(0, 0, this.overlay.width, 
      this.overlay.height);
    };
    
    this.resize = function(left,top,wDiv,hDiv){
      this.overlay.style.left = left;
      this.overlay.style.top = top;
      this.overlay.width = this.canvas.clientWidth/wDiv;
      this.overlay.height = this.canvas.clientWidth/hDiv;
      this.overlay.style.zIndex = 1;
    };
  }
  var ol = new overlayParent();
  var Overlay = function(mainCanvas,type){
    this.canvas = mainCanvas;
    this.type = type;
  };
  Overlay.prototype = ol;


/* ***********Fim Camadas.js************************* */
/* ************************************************** */

initLightsCamerasAndScenes();
initMaterials();
initSkybox();
initWater();

animate();

    </script>
  </body>
</html>
